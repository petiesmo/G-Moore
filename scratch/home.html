<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <title>Moore's Maps</title>
<style type="text/css">
    #map{
      height:600px;
      width:100%;
    }
	*{
    box-sizing: border-box;
    margin: 0;
	}
	.wrapper{
    margin: auto;
    width: 100%;
    max-width: 800px;
    padding:10px;
    background-color: #ccc;
	}
	fieldset{
    float: left;
    width: 50%;
    display: inline-block;
    box-sizing: border-box;
	}
	fieldset input{
    width: 100%;
	}
</style>
</head>	

<body>
	<h1>Moore's Decline Map</h1>
	<h4>Provide positions of Origin and Destination to determine</h4>
	<h4>Distance and Azimuth (plus Declination correction)</h4>
	<hr>
<form id="LocationsForm" onsubmit='getData'>	
<table>
<div class="wrapper">
	   	<label for="Site">Choose a Site:</label>
		<!--TODO: Load this selector from CSV/JSON -->
		<!--Future TODO: Custom for each user, including saved locations -->
		<select name="selectSite" id="Site" onchange="SiteToForm(this)">
			<optgroup label="Alaska">
			<option value="pad1">Pad 1</option>
			</optgroup>
			<optgroup label="California">
			<option value="VAFB1">VAFB1</option>
			<option value="VAFB2">VAFB2</option>
			<optgroup label="Cities">
			<option value="New York">New York</option>
			<option value="Paris">Paris</option>
			</optgroup>
		</select>
    <fieldset style="width:200px; background-color: bisque;">
		<!--Future TODO: Add geolocation-->
		<div id='SiteSelector'></div>
        <legend><strong>Location 1</strong></legend>
		<label for="Lat1">Latitude (N):</label><br>
		<input type="text" id="Lat1" name="Latitude1" value="0"><br>
		<label for="Long1">Longitude (E):</label><br>
		<input type="text" id="Long1" name="Longitude1" value="0"><br>
	</fieldset>
	<fieldset style="width:200px; background-color: cadetblue;">
		<div id='SiteSelector'></div>
        <legend><strong>Location 2</strong></legend>
		<label for="Lat2">Latitude2 (N):</label><br>
		<input type="text" id="Lat2" name="Latitude2" value="10"><br>
		<label for="Long2">Longitude2 (E):</label><br>
		<input type="text" id="Long2" name="Longitude2" value="20"><br>
	</fieldset>
	<fieldset style="width:350px; background-color: silver;">
		Location 1: Latitude: <span id="lat1"></span>°N, Longitude: <span id="lon1"></span>°E<br />
		Location 2: Latitude: <span id="lat2"></span>°N, Longitude: <span id="lon2"></span>°E<br />
		<div id="origin"></div>
		<div id="dest"></div>
		<div id="dist"></div>
        <div id="bearing"></div>
		<div id="decline"></div>
	</fieldset>
</div>
<input type="submit" value="Submit">
<input type="reset" value="Reset">
</form>
<br>

<div id="map"></div>
<hr>
<div id="attribution">
    <h4>Attributions:</h4>
    <p>
    Declination calculated by NOAA (www.ngdc.noaa.gov)<br>
    Distance and Bearing calculated by Google
</p>
</div>

<script>
 //Derived from the Google Maps API templates
 let marker1, marker2;
 let poly, geodesicPoly;
 let map
 //Default starting positions
 var mapcenter = {lat: 14, lng: -40};
 var pos1 = {lat: 40.714, lng: -74.006};  //New York
 var pos2 = {lat: 48.857, lng: 2.352};  //Paris
 var compassrose = `https://www.ngdc.noaa.gov/geomag/image/compass/compass_0.png`
 var degrees = 76  //TODO: Change this number!
 var myDecline = 0
 
 function initMap() {
   map = new google.maps.Map(document.getElementById("map"), {
	 zoom: 2,
	 center: mapcenter,
   });
   map.controls[google.maps.ControlPosition.TOP_CENTER].push(
	 document.getElementById("info")
   );
    
   //Create markers that can be dragged
   marker1 = new google.maps.Marker({
	 map,
	 draggable: true,
	 position: pos1,
	 label: '1'
   });

   marker2 = new google.maps.Marker({
	 map,
	 draggable: true,
	 position: pos2,
	 label: '2'
   });
   refitBounds(map);

   google.maps.event.addListener(marker1, "mouseup", updateMap);
   google.maps.event.addListener(marker2, "mouseup", updateMap);
   //"Straight line"
   poly = new google.maps.Polyline({
	 strokeColor: "#FF0000",
	 strokeOpacity: 1.0,
	 strokeWeight: 3,
	 map: map,
   });
   //Spherical arc
   geodesicPoly = new google.maps.Polyline({
	 strokeColor: "#CC0099",
	 strokeOpacity: 1.0,
	 strokeWeight: 3,
	 geodesic: true,
	 map: map,
   });
   updateMap();
 }
 function refitBounds() {
	//Resize map to fit around selected points  
	const bounds = new google.maps.LatLngBounds(
	marker1.getPosition(),
	marker2.getPosition()
   );
    map.fitBounds(bounds);
 }
 async function getDecline(posA) {
    //Build the URL
	console.log(posA.lat())
    let calcParams = {
        browserRequest:false,
        magneticComponent:"d",
        lat1: posA.lat(), lat1Hemisphere:"N",
        lon1: posA.lng(), lon1Hemisphere:"W",
        model:"WMM",
        resultFormat:"json"}
	const calcURL = new URL('https://www.ngdc.noaa.gov/geomag-web/calculators/calculateDeclination')
    for(const [key,value] of Object.entries(calcParams)) {
        calcURL.searchParams.append(key,value)}
    //console.log(calcURL.href)
  	const response = await fetch(calcURL);
    const magData = await response.json();
    myDecline = magData.result[0].declination
    console.log('Decline is:', myDecline)
	document.getElementById("decline").textContent = `Declination (at Origin): ${myDecline}°`;
    return myDecline;
 }
 
function updateMap() {
   const p1 = marker1.position
   const p2 = marker2.position
   const path = [p1,p2];
   console.log(`Marker1: ${p1}`)
   poly.setPath(path);
   geodesicPoly.setPath(path);
   const heading = google.maps.geometry.spherical.computeHeading(p1, p2);
   const distance = google.maps.geometry.spherical.computeDistanceBetween(p1, p2);	
   document.getElementById("origin").textContent = `Origin (1): ${p1}`;
   document.getElementById("dest").textContent = `Dest.(2): ${p2}`;
   document.getElementById("bearing").textContent = `Bearing: ${heading.toFixed(4)}°`;
   document.getElementById("dist").textContent = `Distance: ${(distance/1000).toFixed(3)} km`;
   getDecline(p1);
 }
</script>

<script>
	//<!--TODO: Changing selector populates form--> 
	function SiteToForm(SiteName){
		console.log(`User picked ${SiteName}`)
	}
	//Acquire Positions 1,2 data from the form
	const forms = document.querySelectorAll('form')
	const submitInput = forms[0].querySelector('input[type="submit"]')
	function getData(e){
		e.preventDefault();
		const formdata = new FormData(forms[0])
		document.getElementById("lat1").textContent = formdata.get("Latitude1")
		document.getElementById("lon1").textContent = formdata.get("Longitude1")
		document.getElementById("lat2").textContent = formdata.get("Latitude2")
		document.getElementById("lon2").textContent = formdata.get("Longitude2")
		const p1 = new google.maps.LatLng(formdata.get("Latitude1"),formdata.get("Longitude1"))
		const p2 = new google.maps.LatLng(formdata.get("Latitude2"),formdata.get("Longitude2"))
		marker1.setPosition(p1)
		marker2.setPosition(p2)
		//marker1.setIcon(compassrose = `https://www.ngdc.noaa.gov/geomag/image/compass/compass_76.png`)
		//marker1.icon.anchor=(0,0);
   		//marker1.icon.scaledSize=(5,5);
		refitBounds()
        updateMap()
	}
	
	document.addEventListener('DOMContentLoaded',function(){
		submitInput.addEventListener('click', getData, false);},false)
</script>

<script async defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8OhoxKqPqPifoJM4bh0ztgUjxt71VGFw&callback=initMap&libraries=geometry">
</script>
</body>
</html>
